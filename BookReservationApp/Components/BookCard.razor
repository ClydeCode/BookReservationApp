@using BookReservationApp.Data.Models;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Components.Authorization;
@using System.Security.Claims;
@using Microsoft.EntityFrameworkCore
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject DatabaseService Database

<MudCard Width="300px">
    <MudCardMedia Image=@ImageURL Height="200"/>
    <MudCardContent>
        <MudText Typo="Typo.h5">@Title</MudText>
        <MudText Typo="Typo.body2">@Description</MudText>
    </MudCardContent>
    <MudCardActions>
        <MudIconButton Icon="@_bookmarkIcon" OnClick="ReserveToggle" Color="Color.Primary" aria-label="add to reservations"></MudIconButton>
        <MudIconButton Icon="@_favoriteIcon" OnClick="FavoriteToggle" Color="Color.Secondary" aria-label="add to favorite"></MudIconButton>
        <AuthorizeView Roles="Admin">
            <Authorized>
                <MudIconButton Class="ml-auto" Icon="@Icons.Material.Filled.Delete" OnClick="OnButtonClicked" Color="Color.Secondary" aria-label="delete"></MudIconButton>
            </Authorized>
        </AuthorizeView>
    </MudCardActions>
</MudCard>

<MudMessageBox @ref="mbox" Title="Ispėjimas" CancelText="Cancel" Style="width: 500px">
    <MessageContent>
        Ar tikrai <b><i>norite</i></b> ištrinti?
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.DeleteForever">Ištrinti</MudButton>
    </YesButton>
</MudMessageBox>

@code {
    [Parameter]
    public int Id { get; set; }
    [Parameter]
    public string? ImageURL { get; set; }
    [Parameter]
    public string? Title { get; set; }
    [Parameter]
    public string? Description { get; set; }
    [Parameter]
    public string? ReservedBy { get; set; }
    public bool isFavorite { get; set; }

    string _favoriteIcon = Icons.Material.Filled.FavoriteBorder;
    string _bookmarkIcon = Icons.Material.Filled.BookmarkBorder;

    MudMessageBox mbox { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    private ClaimsPrincipal user { get; set; }
    private string userId { get; set; }

    protected override void OnInitialized()
    {
        AuthenticateUser();

        if (Database.GetFavoriteByIdAndUserId(Id, userId) != null) isFavorite = true;

        _favoriteIcon = isFavorite == false ?
            Icons.Material.Filled.FavoriteBorder : Icons.Material.Filled.Favorite;

        _bookmarkIcon = ReservedBy == null ?
            Icons.Material.Filled.BookmarkBorder : ReservedBy == userId ?
                Icons.Material.Filled.Bookmark : Icons.Material.Filled.Bookmarks;

        base.OnInitialized();
    }

    async void AuthenticateUser()
    {
        var authState = await authenticationStateTask;
        user = authState.User;

        userId = user.FindFirstValue(ClaimTypes.NameIdentifier);
    }

    void FavoriteToggle()
    {
        if (user.Identity.IsAuthenticated)
        {
            if (!isFavorite)
            {
                Database.AddFavorite(new FavoriteModel { UserId = userId, BookId = Id });

                isFavorite = true;
            }
            else
            {
                Database.DeleteFavoriteByIdAndUserId(Id, userId);

                isFavorite = false;
            }
            _favoriteIcon = _favoriteIcon == Icons.Material.Filled.FavoriteBorder 
                    ? Icons.Material.Filled.Favorite : Icons.Material.Filled.FavoriteBorder;  
        }
    }

    async void ReserveToggle()
    {
        if (user.Identity.IsAuthenticated)
        {
            if (ReservedBy == null)
            {
                var entity = Database.GetBookById(Id);

                entity.ReservedBy = userId;

                Database.UpdateBook(Id, entity);

                ReservedBy = userId;
                _bookmarkIcon = Icons.Material.Filled.Bookmark;
            }
            else if (ReservedBy == userId)
            {
                var entity = Database.GetBookById(Id);

                entity.ReservedBy = null;

                Database.UpdateBook(Id, entity);

                ReservedBy = null;
                _bookmarkIcon = Icons.Material.Filled.BookmarkBorder;
            }
        }
    }

    async void OnButtonClicked()
    {
        await mbox.Show();

        Database.DeleteBook(Id);
    }
}