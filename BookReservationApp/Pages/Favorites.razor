@page "/favorites"
@using BookReservationApp.Pages.Account
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims;
@using BookReservationApp.Components
@using BookReservationApp.Data.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ContextDb> DBFactory

<CascadingAuthenticationState>
	<AuthorizeView>
		<Authorized>
			<MudText Typo="Typo.h4" Class="pb-3">Išsaugoti</MudText>

			<MudContainer MaxWidth="MaxWidth.False" Class="d-flex gap-10 flex-wrap">
				@foreach (var book in Books)
				{
					<BookCard Id=@book.Id
						  ImageURL=@book.ImageURL
						  Title=@book.Title
						  Description=@book.Description
						  ReservedBy=@book.ReservedBy />
				}
			</MudContainer>
		</Authorized>
		<NotAuthorized>
			<RedirectToLogin />
		</NotAuthorized>
	</AuthorizeView>
</CascadingAuthenticationState>

@code {
	[CascadingParameter]
	private Task<AuthenticationState> authenticationStateTask { get; set; }
	private ClaimsPrincipal user { get; set; }

	IEnumerable<BookModel>? Books;

	protected override async Task OnInitializedAsync()
	{
		AuthenticateUser();

		var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

		using var context = DBFactory.CreateDbContext();

		if (context is not null && context.Books is not null)
			Books = context.Books
				.Include(x => x.Favorite)
				.Where(x => x.Favorite.UserId == userId && x.Favorite.BookId == x.Id)
				.ToList();

		await base.OnInitializedAsync();
	}

	async void AuthenticateUser()
	{
		var authState = await authenticationStateTask;
		user = authState.User;
	}
}